name: Upload CSV to Google Cloud Storage, run dbt and checks in Soda

on:
  push:
    branches:
      - main
    paths:
      - 'sample_data/**'
      - 'dbt_soda_project/**'
      - 'soda/**'
      
jobs:
  upload-to-gcs-run-dbt-soda-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@main

    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.10' 

    - name: Install Poetry and Soda
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        pip install -i https://pypi.cloud.soda.io soda-bigquery==1.0.4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_JSON }}

    - name: Upload to Google Cloud Storage
      uses: google-github-actions/upload-cloud-storage@v1
      with:
        path: 'sample_data'
        destination: ${{ secrets.GCS_LOCATION }}

    - name: Install Poetry Dependencies
      run: |
        poetry install

    - name: Run Poetry Variables and Installing dbt Dependencies
      working-directory: ./dbt_soda_project
      run: |
        echo "Switched to $(pwd)"
        poetry run dbt deps

    - name: Run dbt
      working-directory: ./
      run: |
        poetry run dbt run --project-dir dbt_soda_project/ --profiles-dir dbt_soda_project/

    - name: Perform Soda Scan
      uses: sodadata/soda-github-action@main
      env:
         GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
         SODA_API_KEY_ID: ${{ secrets.SODA_API_KEY_ID }}
         SODA_API_KEY_SECRET: ${{ secrets.SODA_API_KEY_SECRET }}
      with:
        soda_library_version: v1.0.4
        data_source: soda_ci_cd
        configuration: ./soda/configuration.yml
        checks: ./soda/checks.yml

