name: Upload CSV to Google Cloud Storage and Run dbt

on:
  push:
    branches:
      - main
    paths:
      - 'sample_data/**'
      - 'dbt_soda_project/**'
      
jobs:
  upload-to-gcs-and-run-dbt:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@main

    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.10' 

    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Upload to Google Cloud Storage
      uses: google-github-actions/upload-cloud-storage@v1
      with:
        path: 'sample_data'
        destination: ${{ secrets.GCS_LOCATION }}

    - name: Install Dependencies
      run: |
        poetry install

    - name: Run Poetry Variables and Installing dbt Dependencies
      working-directory: ./dbt_soda_project
      run: |
        echo "Switched to $(pwd)"
        poetry run dbt deps

    - name: Run dbt
      working-directory: ./
      run: |
        poetry run dbt run --project-dir dbt_soda_project/ --profiles-dir dbt_soda_project/

    - name: Soda test
      env:
         GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
         SODA_API_KEY_ID: ${{ secrets.SODA_API_KEY_ID }}
         SODA_API_KEY_SECRET: ${{ secrets.SODA_API_KEY_SECRET }}
      run: |
        poetry run soda test-connection -d soda_ci_cd -c configuration.yml


